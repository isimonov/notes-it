Блокировка - в реляционных базах данных это установка метки на запись, что запись заблокирована для изменений.
# Оптимистичные

При оптимистичной блокировке на базе данных реальной блокировки не происходит. Вместо этого используется следующий подход - если во время выполнения транзакции она изменяет данные, которые были изменены после её начала, то транзакция прерывается с исключением. Использование оптимистичных блокировок позволяет избежать взаимных блокировок (dead-lock). 

Для реализации оптимистичных блокировок часто используется механизм _MVCC_ (multiversion concurrency control - управление параллельным доступом посредством многоверсионности).  

_MVCC_ может быть реализован на прикладном уровне следующим образом. В таблицу добавляется колонка, которая хранит текущую версию строки. При выполнении update в запросе в секции where передается версия данных, которая была забрана на изменение. Если update вернул 0 изменённых строк, значит данные были уже изменены и транзакцию необходимо запускать заново. Вместо версии можно хранить время последнего изменения данных. Так работает `@Version` в _JPA_.

_MVCC_ так же часто используется самим СУБД для обеспечения механизма изоляции транзакций. В PostgreSQL всем таблицам добавляются скрытые системные колонки с номерами версий и дополнительными атрибутами. Использование этих колонок при выборке, удалении и изменении данных, позволяет достичь заданного уровня изоляции транзакций. Удаление данных в PostgreSQL, например, не удаляет их сразу, а только помечает удалёнными. Для физического удаления применяется команда `VACUUM`.

# Пессимистичные

При пессимистичной блокировке для записи ставится эксклюзивная блокировка на уровне базы данных, запрещая таким образом доступ к данным из других транзакций. Существует несколько видов пессимистичных блокировок:

- При блокировке при чтении запись блокируется когда она запрашивается из базы данных. Недостаток метода в том, что таким образом можно заблокировать даже те данные, которые не изменяются в рамках текущей транзакции.
- При блокировке при записи блокировка данных происходит при их обновлении в базе данных до конца текущей транзакции.

Блокировка с данных снимается либо при коммите, либо при откате транзакции.
# Сравнение оптимистичных и пессимистичных блокировок

При разработке программного обеспечения необходимо выбирать стратегию блокировок данных. При этом следует учитывать следующее:

1. Если ситуация обновления одних и тех же данных в один момент времени относительно редка, то выгоднее использовать оптимистичную блокировку. В этом случае не будут происходить дорогая операция блокировки ресурсов.
2. Если же возможность возникновения ситуации обновления одних и тех же данных достаточно высока, то лучше использовать пессимистичную блокировку, это снизит количество прерванных транзакций.
3. Также следует учитывать, что при оптимистичной блокировке в случае прерывания транзакции её нужно запускать заново.
# Применение

Можно использовать следующими способами:

- @Lock(LockModeType.PESSIMISTIC_WRITE) - над методом в репозитории
- entityManager.lock(myObject, LockModeType.OPTIMISTIC);
- entityManager.find(Student.class, studentId, LockModeType.PESSIMISTIC_READ);
- SELECT ... FOR UPDATE - вручную через запрос на уровне БД
## jakarta.persistence.LockModeType enum

- **OPTIMISTIC** - Получение оптимистичной блокировки чтения для всех сущностей с атрибутами версии.
- **OPTIMISTIC_FORCE_INCREMENT** - Получение оптимистичной блокировки чтения для всех объектов с атрибутами версии и увеличение значения атрибута версии.
- **PESSIMISTIC_READ** - Немедленное получение долговременной блокировки чтения данных, чтобы предотвратить их изменение или удаление. Другие транзакции могут читать данные, пока поддерживается блокировка, но не могут изменять или удалять данные. Persistence provider-у разрешается получать блокировку записи в базу данных при запросе блокировки чтения, но не наоборот.
- **PESSIMISTIC_WRITE** - Немедленное получение долговременной блокировки записи данных, чтобы предотвратить чтение, изменение или удаление данных.
- **PESSIMISTIC_FORCE_INCREMENT** - Немедленное получение долговременной блокировки данных, чтобы предотвратить изменение или удаление данных, и увеличение атрибута версии у версионных сущностей.
- **READ** - Синоним для OPTIMISTIC. Использование LockModeType.OPTIMISTIC предпочтительнее для новых приложений.
- **WRITE** - Синоним для OPTIMISTIC_FORCE_INCREMENT. Использование LockModeType.OPTIMISTIC_FORCE_INCREMENT предпочтительнее для новых приложений.
- **NONE** - Никакой дополнительной блокировки не произойдёт с данными в базе данных.

